<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ê–≤—Ç–æ—Å—É—Ñ–ª–µ—Ä V2.0</title>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
        }
        #container {
            display: flex;
            min-height: 100vh;
        }
        #editor-container {
            width: 40%;
            background: white;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            position: relative;
        }
        #editor {
            width: 100%;
            height: calc(100vh - 60px);
            padding: 15px;
            font-size: 16px;
            border: none;
            resize: none;
        }
        #preview {
            width: 60%;
            padding: 40px;
            font-size: 22px;
            line-height: 1.6;
            overflow-y: auto;
        }
        .editor-header {
            padding: 10px 15px;
            background: #2c3e50;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .sufler-highlight {
            background: #FFFF00 !important;
            color: #000 !important;
            border-radius: 3px !important;
            padding: 0 2px !important;
        }
        .sufler-active-block {
            background: rgba(173, 216, 230, 0.3) !important;
            transition: background 0.3s ease !important;
        }
        .control-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px;
            border-radius: 5px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .control-btn {
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
        }
        #suflerToggle {
            background: #4CAF50;
        }
        #toggleEditorBtn {
            background: #3498db;
        }
        #suflerStatus {
            margin-top: 5px;
            font-size: 13px;
        }
        .hidden-editor {
            display: none;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/marked@4.0.0/marked.min.js"></script>
</head>
<body>
    <div id="container">
        <div id="editor-container">
            <div class="editor-header">
                <h2>–†–µ–¥–∞–∫—Ç–æ—Ä</h2>
                <button id="toggleEditorBtn" class="control-btn">üìù –°–∫—Ä—ã—Ç—å</button>
            </div>
            <textarea id="editor" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏..."></textarea>
        </div>
        <div id="preview"></div>
    </div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
        const editor = document.getElementById('editor');
        const preview = document.getElementById('preview');
        const editorContainer = document.getElementById('editor-container');
        
        editor.addEventListener('input', () => {
            preview.innerHTML = marked.parse(editor.value);
            localStorage.setItem('suflerContent', editor.value);
        });

        if (localStorage.getItem('suflerContent')) {
            editor.value = localStorage.getItem('suflerContent');
            preview.innerHTML = marked.parse(editor.value);
        }

        // –ê–≤—Ç–æ—Å—É—Ñ–ª–µ—Ä
        (function() {
            'use strict';
            
            const config = {
                wordWeights: [0.1, 0.3, 0.5, 0.7, 0.9],
                minWordLength: 3,
                confidenceThreshold: 0.3,
                scrollDuration: 800,
                wordsBufferSize: 5,
                targetPositionRatio: 0.4
            };
            
            let recognition;
            let isActive = false;
            let wordsBuffer = [];
            let lastProcessedIndex = 0;
            
            // –°–æ–∑–¥–∞–µ–º –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
            const panel = document.createElement('div');
            panel.className = 'control-panel';
            panel.innerHTML = `
                <button id="suflerToggle" class="control-btn">üé§ –í–∫–ª—é—á–∏—Ç—å</button>
                <div id="suflerStatus">–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ</div>
            `;
            document.body.appendChild(panel);
            
            const suflerToggle = document.getElementById('suflerToggle');
            const statusEl = document.getElementById('suflerStatus');
            
            // –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
            function centerElement(element) {
                if (!element) return;
                const rect = element.getBoundingClientRect();
                window.scrollTo({
                    top: rect.top + window.pageYOffset - (window.innerHeight * config.targetPositionRatio),
                    behavior: 'smooth'
                });
            }
            
            function findBestMatch(words) {
                const elements = document.querySelectorAll('#preview p, #preview li, #preview h1, #preview h2, #preview h3');
                let bestMatch = { element: null, score: 0 };
                
                elements.forEach(el => {
                    const text = el.textContent.toLowerCase();
                    let score = 0;
                    
                    words.forEach((word, i) => {
                        if (word.length >= config.minWordLength && text.includes(word)) {
                            score += config.wordWeights[i] || 0;
                        }
                    });
                    
                    if (score > bestMatch.score) {
                        bestMatch = { element: el, score: score };
                    }
                });
                
                return bestMatch.element;
            }
            
            function processWords(words) {
                document.querySelectorAll('.sufler-highlight, .sufler-active-block').forEach(el => {
                    el.classList.remove('sufler-highlight', 'sufler-active-block');
                });
                
                const target = findBestMatch(words);
                if (target) {
                    target.classList.add('sufler-active-block');
                    let html = target.innerHTML;
                    
                    words.forEach(word => {
                        if (word.length >= config.minWordLength) {
                            html = html.replace(
                                new RegExp(`(${word})`, 'gi'),
                                '<span class="sufler-highlight">$1</span>'
                            );
                        }
                    });
                    
                    target.innerHTML = html;
                    centerElement(target);
                    statusEl.textContent = `–ù–∞–π–¥–µ–Ω–æ: "${words.join(' ')}"`;
                }
            }
            
            function initRecognition() {
                if (!('webkitSpeechRecognition' in window)) {
                    statusEl.textContent = '–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è';
                    suflerToggle.disabled = true;
                    return null;
                }
                
                const rec = new webkitSpeechRecognition();
                rec.continuous = true;
                rec.interimResults = true;
                rec.lang = 'ru-RU';
                
                rec.onresult = (event) => {
                    const results = Array.from(event.results);
                    const last = results[results.length - 1];
                    
                    if (last.isFinal) {
                        const transcript = last[0].transcript.trim();
                        const newWords = transcript.split(/\s+/)
                            .filter(w => w.length >= config.minWordLength)
                            .map(w => w.toLowerCase());
                        
                        wordsBuffer = [...wordsBuffer, ...newWords].slice(-20);
                        
                        if (wordsBuffer.length - lastProcessedIndex >= config.wordsBufferSize) {
                            const wordsToProcess = wordsBuffer.slice(lastProcessedIndex);
                            lastProcessedIndex = wordsBuffer.length;
                            processWords(wordsToProcess);
                        }
                    }
                };
                
                rec.onerror = (event) => {
                    console.log('–û—à–∏–±–∫–∞:', event.error);
                    if (isActive) setTimeout(() => recognition.start(), 300);
                };
                
                rec.onend = () => {
                    if (isActive) recognition.start();
                };
                
                return rec;
            }
            
            function startRecognition() {
                if (!recognition) recognition = initRecognition();
                if (!recognition) return;
                
                try {
                    recognition.start();
                    isActive = true;
                    suflerToggle.textContent = 'üî¥ –í—ã–∫–ª—é—á–∏—Ç—å';
                    suflerToggle.style.background = '#f44336';
                    statusEl.textContent = '–°–ª—É—à–∞—é...';
                    wordsBuffer = [];
                    lastProcessedIndex = 0;
                } catch (error) {
                    console.error(error);
                    setTimeout(startRecognition, 500);
                }
            }
            
            function stopRecognition() {
                isActive = false;
                if (recognition) recognition.stop();
                suflerToggle.textContent = 'üé§ –í–∫–ª—é—á–∏—Ç—å';
                suflerToggle.style.background = '#4CAF50';
                statusEl.textContent = '–ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤—ã–∫–ª—é—á–µ–Ω';
            }
            
            // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
            suflerToggle.addEventListener('click', () => {
                if (isActive) stopRecognition();
                else startRecognition();
            });
            
            document.addEventListener('keydown', (e) => {
                if (e.code === 'Pause') {
                    e.preventDefault();
                    if (isActive) stopRecognition();
                    else startRecognition();
                }
            });
        })();
    </script>
</body>
</html>