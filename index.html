(function() {
    'use strict';

    // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    const defaultConfig = {
        mode: 'highlight-scroll',
        wordsToUse: 3,
        searchRadius: 5,
        sensitivity: 50,
        minWordLength: 2
    };

    // –¢–µ–∫—É—â–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
    let config = {...defaultConfig};

    // –≠–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
    const editor = document.getElementById('editor');
    const preview = document.getElementById('preview');
    const editorContainer = document.getElementById('editor-container');
    const suflerToggle = document.getElementById('suflerToggle');
    const toggleEditorBtn = document.getElementById('toggleEditorBtn');
    const toggleThemeBtn = document.getElementById('toggleThemeBtn');
    const settingsBtn = document.getElementById('settingsBtn');
    const closeSettingsBtn = document.querySelector('.close-settings');
    const saveSettingsBtn = document.getElementById('saveSettings');
    const resetSettingsBtn = document.getElementById('resetSettings');
    const statusEl = document.getElementById('suflerStatus');
    const controlPanel = document.querySelector('.control-panel');
    const panelToggle = document.querySelector('.panel-toggle');
    const settingsPanel = document.querySelector('.settings-panel');
    const karaokePanel = document.querySelector('.karaoke-panel');
    const karaokeText = document.getElementById('karaokeText');

    // –≠–ª–µ–º–µ–Ω—Ç—ã –Ω–∞—Å—Ç—Ä–æ–µ–∫
    const modeSelect = document.getElementById('modeSelect');
    const wordsRange = document.getElementById('wordsRange');
    const wordsValue = document.getElementById('wordsValue');
    const radiusRange = document.getElementById('radiusRange');
    const radiusValue = document.getElementById('radiusValue');
    const sensitivityRange = document.getElementById('sensitivityRange');
    const sensitivityValue = document.getElementById('sensitivityValue');
    const minLengthRange = document.getElementById('minLengthRange');
    const minLengthValue = document.getElementById('minLengthValue');

    // –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    let recognition;
    let isActive = false;
    let wordsBuffer = [];
    let lastFoundElement = null;
    let isDarkTheme = false;
    let isPanelHidden = true;
    let allElements = [];
    let autoScrollTimer;
    let currentHighlightIndex = 0;
    let currentKaraokeIndex = 0;

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
    function initEditor() {
        if (localStorage.getItem('suflerContent')) {
            editor.value = localStorage.getItem('suflerContent');
            updatePreview();
        }
        if (localStorage.getItem('darkTheme') === 'true') {
            toggleTheme();
        }
        // –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫
        loadSettings();
        editor.addEventListener('input', () => {
            updatePreview();
            localStorage.setItem('suflerContent', editor.value);
        });

        function adjustTextarea() {
            editor.style.height = 'auto';
            editor.style.height = editor.scrollHeight + 'px';
        }

        editor.addEventListener('input', adjustTextarea);
        adjustTextarea();
        window.addEventListener('load', () => editor.focus());
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ preview
    function updatePreview() {
        preview.innerHTML = marked.parse(editor.value);
        allElements = Array.from(preview.querySelectorAll('p, h1, h2, h3, li, div'));
    }

    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–¥–∞–∫—Ç–æ—Ä–æ–º
    function initEditorControls() {
        toggleEditorBtn.addEventListener('click', () => {
            editorContainer.classList.toggle('editor-hidden');
            preview.classList.toggle('preview-full-width');
            toggleEditorBtn.innerHTML = editorContainer.classList.contains('editor-hidden')
                ? 'üìù –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–¥–∞–∫—Ç–æ—Ä'
                : 'üìù –°–∫—Ä—ã—Ç—å —Ä–µ–¥–∞–∫—Ç–æ—Ä';
        });
    }

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–µ–º—ã
    function toggleTheme() {
        isDarkTheme = !isDarkTheme;
        document.body.classList.toggle('dark-theme');
        localStorage.setItem('darkTheme', isDarkTheme);
        toggleThemeBtn.innerHTML = isDarkTheme ? 'üåû –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞' : 'üåì –¢—ë–º–Ω–∞—è —Ç–µ–º–∞';
    }

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø–∞–Ω–µ–ª–∏
    function togglePanel() {
        isPanelHidden = !isPanelHidden;
        controlPanel.classList.toggle('hidden');
        panelToggle.classList.toggle('hidden');
        panelToggle.innerHTML = isPanelHidden ? '‚öôÔ∏è' : '‚ùå';
    }

    // –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏
    function initSpeechRecognition() {
        if (!('webkitSpeechRecognition' in window)) {
            statusEl.textContent = '–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è';
            suflerToggle.disabled = true;
            return;
        }

        recognition = new webkitSpeechRecognition();
        recognition.continuous = true;
        recognition.interimResults = true;
        recognition.lang = 'ru-RU';

        recognition.onresult = (event) => {
            const results = Array.from(event.results);
            const last = results[results.length - 1];
            if (last && !last.isFinal) {
                const transcript = last[0].transcript.trim();
                const newWords = transcript.toLowerCase()
                    .split(/\s+/)
                    .filter(w => w.length >= config.minWordLength);
                if (newWords.length > 0) {
                    wordsBuffer = [...wordsBuffer, ...newWords].slice(-10);
                    processSpeech();
                }
            }
        };

        recognition.onerror = (event) => {
            if (isActive) setTimeout(() => recognition.start(), 300);
        };

        recognition.onend = () => {
            if (isActive) recognition.start();
        };
    }

    // –ü–æ–ª—É—á–∏—Ç—å –±–ª–∏–∂–∞–π—à–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –ø–æ–∏—Å–∫–∞
    function getNearbyElements() {
        if (!lastFoundElement || !allElements.includes(lastFoundElement)) {
            return allElements.slice(0, config.searchRadius * 2);
        }
        const currentIndex = allElements.indexOf(lastFoundElement);
        const start = Math.max(0, currentIndex - config.searchRadius);
        const end = Math.min(allElements.length, currentIndex + config.searchRadius + 1);
        return allElements.slice(start, end);
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ—á–∏
    function processSpeech() {
        if (wordsBuffer.length === 0) return;

        const searchWords = wordsBuffer.slice(-config.wordsToUse);
        const elementsToSearch = getNearbyElements();
        let bestElement = null;
        let maxMatches = 0;

        elementsToSearch.forEach(el => {
            const text = el.textContent.toLowerCase();
            let matches = 0;
            searchWords.forEach(word => {
                if (text.includes(word)) matches++;
            });

            const matchThreshold = Math.ceil((config.sensitivity / 100) * searchWords.length);
            if (matches >= matchThreshold && matches > maxMatches) {
                maxMatches = matches;
                bestElement = el;
            }
        });

        if (bestElement) {
            if (config.mode === 'karaoke') {
                highlightKaraoke(bestElement, searchWords);
            } else {
                highlightMatches(bestElement, searchWords);
            }

            if (config.mode === 'highlight-scroll') {
                centerElement(bestElement);
            }

            statusEl.textContent = `–ù–∞–π–¥–µ–Ω–æ: "${searchWords.join(' ')}"`;
            lastFoundElement = bestElement;
            resetAutoScrollTimer();
        }
    }

    // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π
    function highlightMatches(element, words) {
        document.querySelectorAll('.sufler-highlight').forEach(el => {
            el.classList.remove('sufler-highlight');
        });

        document.querySelectorAll('.sufler-active-block').forEach(el => {
            el.classList.remove('sufler-active-block');
        });

        element.classList.add('sufler-active-block');

        let newHTML = element.innerHTML;
        words.forEach(word => {
            if (word.length >= config.minWordLength) {
                const regex = new RegExp(`(${escapeRegExp(word)})`, 'gi');
                newHTML = newHTML.replace(regex, '<span class="sufler-highlight">$1</span>');
            }
        });

        element.innerHTML = newHTML;
    }

    // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –≤ —Ä–µ–∂–∏–º–µ "–ö–∞—Ä–∞–æ–∫–µ"
    function highlightKaraoke(element, words) {
        const text = element.textContent;
        karaokeText.innerHTML = text;
        karaokePanel.style.display = 'block';

        words.forEach(word => {
            const regex = new RegExp(`(${escapeRegExp(word)})`, 'gi');
            const highlightedText = text.replace(regex, '<span class="karaoke-highlight">$1</span>');
            karaokeText.innerHTML = highlightedText;
        });
    }

    // –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª–æ–≤
    function escapeRegExp(string) {
        return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    // –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞
    function centerElement(element) {
        if (!element) return;

        const elementRect = element.getBoundingClientRect();
        const targetScrollPos = elementRect.top + window.pageYOffset - (window.innerHeight * 0.3);
        window.scrollTo({
            top: targetScrollPos,
            behavior: 'smooth'
        });
    }

    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—É—Ñ–ª–µ—Ä–æ–º
    function toggleRecognition() {
        if (isActive) {
            stopRecognition();
        } else {
            startRecognition();
        }
    }

    function startRecognition() {
        if (!recognition) initSpeechRecognition();
        try {
            recognition.start();
            isActive = true;
            suflerToggle.classList.add('active');
            suflerToggle.innerHTML = 'üî¥ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å';
            statusEl.textContent = '–°–ª—É—à–∞—é...';
            wordsBuffer = [];
            lastFoundElement = null;
            startAutoScrollTimer();
            window.focus();
        } catch (error) {
            statusEl.textContent = '–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É';
            setTimeout(startRecognition, 500);
        }
    }

    function stopRecognition() {
        isActive = false;
        if (recognition) {
            recognition.stop();
            recognition = null;
        }
        suflerToggle.classList.remove('active');
        suflerToggle.innerHTML = 'üé§ –í–∫–ª—é—á–∏—Ç—å';
        statusEl.textContent = '–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ';
        clearTimeout(autoScrollTimer);
    }

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏
    function showSettings() {
        modeSelect.value = config.mode;
        wordsRange.value = config.wordsToUse;
        wordsValue.textContent = config.wordsToUse;
        radiusRange.value = config.searchRadius;
        radiusValue.textContent = config.searchRadius;
        sensitivityRange.value = config.sensitivity;
        sensitivityValue.textContent = config.sensitivity + '%';
        minLengthRange.value = config.minWordLength;
        minLengthValue.textContent = config.minWordLength;
        settingsPanel.style.display = 'block';
    }

    function hideSettings() {
        settingsPanel.style.display = 'none';
    }

    function loadSettings() {
        const savedSettings = localStorage.getItem('suflerSettings');
        if (savedSettings) {
            config = {...defaultConfig, ...JSON.parse(savedSettings)};
        }
    }

    function saveSettings() {
        config = {
            mode: modeSelect.value,
            wordsToUse: parseInt(wordsRange.value),
            searchRadius: parseInt(radiusRange.value),
            sensitivity: parseInt(sensitivityRange.value),
            minWordLength: parseInt(minLengthRange.value)
        };
        localStorage.setItem('suflerSettings', JSON.stringify(config));
        hideSettings();
    }

    function resetSettings() {
        config = {...defaultConfig};
        localStorage.removeItem('suflerSettings');
        hideSettings();
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏–π –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
    function initSettingsEvents() {
        wordsRange.addEventListener('input', () => {
            wordsValue.textContent = wordsRange.value;
        });

        radiusRange.addEventListener('input', () => {
            radiusValue.textContent = radiusRange.value;
        });

        sensitivityRange.addEventListener('input', () => {
            sensitivityValue.textContent = sensitivityRange.value + '%';
        });

        minLengthRange.addEventListener('input', () => {
            minLengthValue.textContent = minLengthRange.value;
        });

        settingsBtn.addEventListener('click', showSettings);
        closeSettingsBtn.addEventListener('click', hideSettings);
        saveSettingsBtn.addEventListener('click', saveSettings);
        resetSettingsBtn.addEventListener('click', resetSettings);
    }

    // –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏
    function initHotkeys() {
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Pause') {
                e.preventDefault();
                toggleRecognition();
            }

            if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
                e.preventDefault();
                toggleEditorBtn.click();
            }

            if ((e.ctrlKey || e.metaKey) && e.key === 't') {
                e.preventDefault();
                toggleTheme();
            }

            if ((e.ctrlKey || e.metaKey) && e.key === ',') {
                e.preventDefault();
                showSettings();
            }

            if (e.key === 'ArrowUp') {
                e.preventDefault();
                navigateLines(-1);
            }

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                navigateLines(1);
            }

            if (e.key === ' ') {
                e.preventDefault();
                toggleRecognition();
            }

            if (e.key === 'r') {
                e.preventDefault();
                resetToStart();
            }
        });
    }

    function navigateLines(direction) {
        if (!lastFoundElement) {
            lastFoundElement = allElements[0];
        }

        const currentIndex = allElements.indexOf(lastFoundElement);
        const nextIndex = currentIndex + direction;

        if (nextIndex >= 0 && nextIndex < allElements.length) {
            const nextElement = allElements[nextIndex];
            highlightMatches(nextElement, []);
            centerElement(nextElement);
            lastFoundElement = nextElement;
        }
    }

    function resetToStart() {
        lastFoundElement = null;
        wordsBuffer = [];
        document.querySelectorAll('.sufler-highlight').forEach(el => {
            el.classList.remove('sufler-highlight');
        });

        document.querySelectorAll('.sufler-active-block').forEach(el => {
            el.classList.remove('sufler-active-block');
        });

        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    }

    function startAutoScrollTimer() {
        autoScrollTimer = setTimeout(() => {
            if (isActive && !lastFoundElement) {
                const nextElement = allElements.find((el, index) => index > (lastFoundElement ? allElements.indexOf(lastFoundElement) : -1));
                if (nextElement) {
                    centerElement(nextElement);
                }
            }
        }, 10000);
    }

    function resetAutoScrollTimer() {
        clearTimeout(autoScrollTimer);
        startAutoScrollTimer();
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    function initApp() {
        initEditor();
        initEditorControls();
        initSettingsEvents();
        initHotkeys();
        suflerToggle.addEventListener('click', toggleRecognition);
        toggleThemeBtn.addEventListener('click', toggleTheme);
        panelToggle.addEventListener('click', togglePanel);

        setTimeout(() => {
            if (!isActive) {
                startRecognition();
            }
        }, 500);

        const observer = new MutationObserver(() => {
            if (preview.innerHTML.trim()) {
                allElements = Array.from(preview.querySelectorAll('p, h1, h2, h3, li, div'));
                observer.disconnect();
            }
        });

        observer.observe(preview, { childList: true, subtree: true });
    }

    // –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    initApp();
})();
