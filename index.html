<script>
(function() {
    'use strict';

    const config = {
        wordWeights: [0.8, 0.6, 0.4, 0.2, 0.1], // Веса от последнего к первому слову
        minWordLength: 3,
        confidenceThreshold: 0.3,
        scrollDuration: 800,
        wordsToProcess: 10, // Обрабатывать каждые 10 слов
        maxLinesToSearch: 3, // Искать только в 3 ближайших строках
        highlightColor: '#FFFF00',
        blockColor: '#ADD8E633'
    };

    let recognition;
    let isActive = false;
    let wordsBuffer = [];
    let lastProcessedIndex = 0;
    let lastFoundElement = null;

    function initIntegratedSufler() {
        // [Панель управления и UI остается без изменений...]

        // Находит ближайшие элементы для поиска
        function getNearbyElements() {
            const allElements = Array.from(document.querySelectorAll('#preview p, #preview h1, #preview h2, #preview h3, #preview li'));
            
            if (!lastFoundElement) return allElements.slice(0, 5);
            
            const currentIndex = allElements.indexOf(lastFoundElement);
            const start = Math.max(0, currentIndex - 1);
            const end = Math.min(allElements.length, currentIndex + config.maxLinesToSearch + 1);
            
            return allElements.slice(start, end);
        }

        // Улучшенный поиск совпадений с учетом весов
        function findBestMatch(words) {
            const elements = getNearbyElements();
            let bestMatch = { element: null, score: 0 };

            elements.forEach(el => {
                const text = el.textContent.toLowerCase();
                let score = 0;
                let matchedWords = 0;

                // Ищем совпадения с учетом весов
                words.forEach((word, index) => {
                    if (word.length >= config.minWordLength && text.includes(word)) {
                        score += config.wordWeights[index] || 0;
                        matchedWords++;
                    }
                });

                // Учитываем количество совпадений
                if (matchedWords > 0) {
                    score *= (1 + matchedWords * 0.2);
                    if (score > bestMatch.score) {
                        bestMatch = { element: el, score: score };
                    }
                }
            });

            return bestMatch.element;
        }

        // Обработка новых слов
        function processNewWords() {
            if (wordsBuffer.length - lastProcessedIndex >= config.wordsToProcess) {
                const wordsToProcess = wordsBuffer.slice(
                    Math.max(0, wordsBuffer.length - config.wordsToProcess)
                );
                
                const targetElement = findBestMatch(wordsToProcess);
                if (targetElement) {
                    lastFoundElement = targetElement;
                    highlightMatches(targetElement, wordsToProcess);
                    centerElement(targetElement);
                    statusEl.textContent = `Найдено: "${wordsToProcess.slice(-3).join(' ')}..."`;
                }
                
                lastProcessedIndex = wordsBuffer.length;
            }
        }

        // Подсветка совпадений
        function highlightMatches(element, words) {
            element.classList.add('sufler-active-block');
            let newHTML = element.innerHTML;
            
            words.forEach(word => {
                if (word.length >= config.minWordLength) {
                    const regex = new RegExp(`(${word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
                    newHTML = newHTML.replace(regex, '<span class="sufler-highlight">$1</span>');
                }
            });
            
            element.innerHTML = newHTML;
        }

        // Инициализация распознавания речи
        function initRecognition() {
            const rec = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            rec.continuous = true;
            rec.interimResults = true;
            rec.lang = 'ru-RU';

            rec.onresult = (event) => {
                const results = Array.from(event.results);
                const last = results[results.length - 1];
                
                if (last.isFinal) {
                    const transcript = last[0].transcript.trim();
                    const newWords = transcript.toLowerCase()
                        .split(/\s+/)
                        .filter(w => w.length >= config.minWordLength);
                    
                    wordsBuffer = [...wordsBuffer, ...newWords];
                    processNewWords();
                }
            };

            rec.onerror = (event) => {
                if (event.error !== 'no-speech') {
                    console.error('Ошибка распознавания:', event.error);
                }
                if (isActive) setTimeout(() => rec.start(), 300);
            };

            rec.onend = () => {
                if (isActive) rec.start();
            };

            return rec;
        }

        // [Остальные функции (start/stopRecognition, centerElement и т.д.) остаются без изменений]
    }

    // Инициализация после загрузки контента
    const observer = new MutationObserver(() => {
        initIntegratedSufler();
        observer.disconnect();
    });
    observer.observe(document.getElementById('preview'), { childList: true });
})();
</script>