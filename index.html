<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Power BI –°—É—Ñ–ª–µ—Ä</title>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
        }
        #container {
            display: flex;
            min-height: 100vh;
        }
        #editor {
            width: 40%;
            padding: 20px;
            background: white;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }
        #preview {
            width: 60%;
            padding: 40px;
            font-size: 22px;
            line-height: 1.6;
            overflow-y: auto;
        }
        textarea {
            width: 100%;
            height: calc(100vh - 40px);
            border: 1px solid #ddd;
            padding: 15px;
            font-size: 16px;
            resize: none;
            border-radius: 4px;
        }
        h1, h2, h3 {
            color: #2c3e50;
        }
        .sufler-highlight {
            background: #FFFF00 !important;
            color: #000 !important;
            border-radius: 3px !important;
            padding: 0 2px !important;
        }
        .sufler-active-block {
            background: rgba(173, 216, 230, 0.3) !important;
            transition: background 0.5s ease !important;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/marked@4.0.0/marked.min.js"></script>
    <script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        
        function filledCell(cell) {
            return cell !== '' && cell != null;
        }
        
        function loadFileData(filename) {
            if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
                try {
                    var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                    var firstSheetName = workbook.SheetNames[0];
                    var worksheet = workbook.Sheets[firstSheetName];

                    var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                    var filteredData = jsonData.filter(row => row.some(filledCell));

                    var headerRowIndex = filteredData.findIndex((row, index) =>
                        row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                    );
                    
                    if (headerRowIndex === -1 || headerRowIndex > 25) {
                        headerRowIndex = 0;
                    }

                    var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex));
                    csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                    return csv;
                } catch (e) {
                    console.error(e);
                    return "";
                }
            }
            return gk_fileData[filename] || "";
        }
    </script>
</head>
<body>
    <div id="container">
        <div id="editor">
            <h2>–†–µ–¥–∞–∫—Ç–æ—Ä Markdown</h2>
            <textarea placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏ –∑–¥–µ—Å—å..."></textarea>
        </div>
        <div id="preview"></div>
    </div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
        const editor = document.querySelector('#editor textarea');
        const preview = document.getElementById('preview');
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–≤–æ–¥–∞ —Ç–µ–∫—Å—Ç–∞
        editor.addEventListener('input', () => {
            preview.innerHTML = marked.parse(editor.value);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—Å—Ç –≤ localStorage
            localStorage.setItem('suflerContent', editor.value);
        });

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
        const savedContent = localStorage.getItem('suflerContent');
        if (savedContent) {
            editor.value = savedContent;
            preview.innerHTML = marked.parse(savedContent);
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞–∑–º–µ—Ä —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—è
        function adjustTextarea() {
            editor.style.height = 'auto';
            editor.style.height = editor.scrollHeight + 'px';
        }
        editor.addEventListener('input', adjustTextarea);
        adjustTextarea();

        // –§–æ–∫—É—Å –Ω–∞ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', () => {
            editor.focus();
        });
    </script>

    <!-- –°–∫—Ä–∏–ø—Ç —Å—É—Ñ–ª–µ—Ä–∞ -->
    <script>
    // ==UserScript==
    // @name         Power BI –°—É—Ñ–ª–µ—Ä (–ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)
    // @version      1.0
    // @description  –ò–¥–µ–∞–ª—å–Ω–æ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å—É—Ñ–ª–µ—Ä
    // @author       –í–∞—à —Ç–µ—Ö–Ω–∞—Ä—ä
    // ==/UserScript==

    (function() {
        'use strict';

        const config = {
            wordWeights: [0.1, 0.3, 0.5, 0.7, 0.8],
            minWordLength: 3,
            confidenceThreshold: 0.4,
            scrollDuration: 1000,
            targetPositionRatio: 0.4,
            highlightColor: '#FFFF00',
            blockColor: '#ADD8E633'
        };

        function initIntegratedSufler() {
            // –°–æ–∑–¥–∞–µ–º –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
            const panel = document.createElement('div');
            panel.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                z-index: 9999;
                background: rgba(0,0,0,0.8);
                color: white;
                padding: 10px;
                border-radius: 5px;
                font-family: Arial, sans-serif;
            `;

            panel.innerHTML = `
                <button id="suflerToggle" style="
                    background: #4CAF50;
                    color: white;
                    border: none;
                    padding: 8px 15px;
                    border-radius: 4px;
                    cursor: pointer;
                ">üé§ –í–∫–ª—é—á–∏—Ç—å —Å—É—Ñ–ª–µ—Ä</button>
                <div id="suflerStatus" style="margin-top:8px;font-size:13px;">
                    –ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ
                </div>
            `;
            document.body.appendChild(panel);

            const toggleBtn = document.getElementById('suflerToggle');
            const statusEl = document.getElementById('suflerStatus');
            let recognition;
            let isActive = false;

            // –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞
            function centerElement(element) {
                if (!element) return;
                
                const elementRect = element.getBoundingClientRect();
                const viewportHeight = window.innerHeight;
                const targetScrollPos = elementRect.top + window.pageYOffset - (viewportHeight * config.targetPositionRatio);
                
                window.scrollTo({
                    top: targetScrollPos,
                    behavior: 'smooth'
                });
            }

            // –ü–æ–∏—Å–∫ –ª—É—á—à–µ–≥–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è
            function findBestMatch(words) {
                const elements = document.querySelectorAll('#preview p, #preview h1, #preview h2, #preview h3, #preview li');
                let bestMatch = { element: null, score: 0 };

                elements.forEach(el => {
                    const text = el.textContent.toLowerCase();
                    let score = 0;

                    words.forEach((word, index) => {
                        if (word.length >= config.minWordLength && text.includes(word)) {
                            score += config.wordWeights[index] || 0;
                        }
                    });

                    if (score > bestMatch.score) {
                        bestMatch = { element: el, score: score };
                    }
                });

                return bestMatch.element;
            }

            // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∏ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ
            function processWords(words) {
                // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –ø–æ–¥—Å–≤–µ—Ç–æ–∫
                document.querySelectorAll('.sufler-highlight, .sufler-active-block').forEach(el => {
                    el.classList.remove('sufler-highlight', 'sufler-active-block');
                });

                const targetElement = findBestMatch(words);
                
                if (targetElement) {
                    // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –±–ª–æ–∫–∞
                    targetElement.classList.add('sufler-active-block');
                    
                    // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Å–ª–æ–≤
                    let newHTML = targetElement.innerHTML;
                    words.forEach(word => {
                        if (word.length >= config.minWordLength) {
                            newHTML = newHTML.replace(
                                new RegExp(`(${word})`, 'gi'),
                                '<span class="sufler-highlight">$1</span>'
                            );
                        }
                    });
                    targetElement.innerHTML = newHTML;

                    // –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ
                    centerElement(targetElement);
                    statusEl.textContent = `–ù–∞–π–¥–µ–Ω–æ: "${words.slice(-1)[0]}"`;
                } else {
                    statusEl.textContent = '–ù–µ –Ω–∞–π–¥–µ–Ω–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π';
                }
            }

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
            function initRecognition() {
                if (!('webkitSpeechRecognition' in window)) {
                    statusEl.textContent = '–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è';
                    toggleBtn.disabled = true;
                    return null;
                }

                const rec = new webkitSpeechRecognition();
                rec.continuous = true;
                rec.interimResults = true;
                rec.lang = 'ru-RU';

                rec.onresult = function(event) {
                    const results = Array.from(event.results);
                    const last = results[results.length - 1];
                    
                    if (last.isFinal) {
                        const transcript = last[0].transcript.trim();
                        const confidence = last[0].confidence;
                        
                        if (confidence >= config.confidenceThreshold) {
                            const words = transcript.split(/\s+/)
                                .filter(w => w.length >= config.minWordLength)
                                .slice(-config.wordWeights.length);
                            
                            if (words.length > 0) {
                                processWords(words);
                            }
                        }
                    }
                };

                rec.onerror = function(event) {
                    statusEl.textContent = `–û—à–∏–±–∫–∞: ${event.error}`;
                    stopRecognition();
                };

                rec.onend = function() {
                    if (isActive) {
                        setTimeout(startRecognition, 300);
                    }
                };

                return rec;
            }

            function startRecognition() {
                if (!recognition) {
                    recognition = initRecognition();
                    if (!recognition) return;
                }

                try {
                    recognition.start();
                    isActive = true;
                    toggleBtn.textContent = 'üî¥ –í—ã–∫–ª—é—á–∏—Ç—å';
                    toggleBtn.style.background = '#f44336';
                    statusEl.textContent = '–°–ª—É—à–∞—é...';
                } catch (error) {
                    statusEl.textContent = '–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É';
                    console.error(error);
                }
            }

            function stopRecognition() {
                if (recognition) {
                    recognition.stop();
                }
                isActive = false;
                toggleBtn.textContent = 'üé§ –í–∫–ª—é—á–∏—Ç—å';
                toggleBtn.style.background = '#4CAF50';
                statusEl.textContent = '–ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤—ã–∫–ª—é—á–µ–Ω';
            }

            // –ö–Ω–æ–ø–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
            toggleBtn.addEventListener('click', function() {
                if (isActive) {
                    stopRecognition();
                } else {
                    startRecognition();
                }
            });
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
        const observer = new MutationObserver(function(mutations) {
            initIntegratedSufler();
            observer.disconnect();
        });
        observer.observe(document.getElementById('preview'), { childList: true });
    })();
    </script>
</body>
</html>