<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ê–≤—Ç–æ - —Å—É—Ñ–ª–µ—Ä by Vatnik</title>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
        }
        #container {
            display: flex;
            min-height: 100vh;
            transition: all 0.3s ease;
        }
        #editor-container {
            width: 40%;
            background: white;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            position: relative;
        }
        #editor {
            width: 100%;
            height: calc(100vh - 60px);
            padding: 15px;
            font-size: 16px;
            border: none;
            resize: none;
        }
        #preview {
            width: 60%;
            padding: 40px;
            font-size: 22px;
            line-height: 1.6;
            overflow-y: auto;
        }
        .editor-header {
            padding: 10px 15px;
            background: #2c3e50;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .toggle-editor {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        .sufler-highlight {
            background: #FFFF00 !important;
            color: #000 !important;
            border-radius: 3px !important;
            padding: 0 2px !important;
        }
        .sufler-active-block {
            background: rgba(173, 216, 230, 0.3) !important;
            transition: background 0.5s ease !important;
        }
        .hidden-editor {
            transform: translateX(-100%);
            width: 0 !important;
            opacity: 0;
        }
        .full-width-preview {
            width: 100% !important;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/marked@4.0.0/marked.min.js"></script>
</head>
<body>
    <div id="container">
        <div id="editor-container">
            <div class="editor-header">
                <h2>–†–µ–¥–∞–∫—Ç–æ—Ä Markdown</h2>
                <button class="toggle-editor">–°–∫—Ä—ã—Ç—å</button>
            </div>
            <textarea id="editor" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏ –∑–¥–µ—Å—å..."></textarea>
        </div>
        <div id="preview"></div>
    </div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
        const editor = document.getElementById('editor');
        const preview = document.getElementById('preview');
        const editorContainer = document.getElementById('editor-container');
        const toggleBtn = document.querySelector('.toggle-editor');
        const container = document.getElementById('container');
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–≤–æ–¥–∞ —Ç–µ–∫—Å—Ç–∞
        editor.addEventListener('input', () => {
            preview.innerHTML = marked.parse(editor.value);
            localStorage.setItem('suflerContent', editor.value);
        });

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
        const savedContent = localStorage.getItem('suflerContent');
        if (savedContent) {
            editor.value = savedContent;
            preview.innerHTML = marked.parse(savedContent);
        }

        // –ö–Ω–æ–ø–∫–∞ —Å–∫—Ä—ã—Ç–∏—è/–ø–æ–∫–∞–∑–∞ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
        toggleBtn.addEventListener('click', () => {
            editorContainer.classList.toggle('hidden-editor');
            preview.classList.toggle('full-width-preview');
            
            if (editorContainer.classList.contains('hidden-editor')) {
                toggleBtn.textContent = '–ü–æ–∫–∞–∑–∞—Ç—å';
            } else {
                toggleBtn.textContent = '–°–∫—Ä—ã—Ç—å';
            }
        });

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞–∑–º–µ—Ä —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—è
        function adjustTextarea() {
            editor.style.height = 'auto';
            editor.style.height = editor.scrollHeight + 'px';
        }
        editor.addEventListener('input', adjustTextarea);
        adjustTextarea();

        // –§–æ–∫—É—Å –Ω–∞ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', () => {
            editor.focus();
        });
    </script>

    <!-- –°–∫—Ä–∏–ø—Ç —Å—É—Ñ–ª–µ—Ä–∞ -->
    <script>
    (function() {
        'use strict';

        const config = {
            wordWeights: [0.1, 0.3, 0.5, 0.7, 0.8],
            minWordLength: 3,
            confidenceThreshold: 0.4,
            scrollDuration: 1000,
            targetPositionRatio: 0.4,
            highlightColor: '#FFFF00',
            blockColor: '#ADD8E633'
        };

        function initIntegratedSufler() {
            // –°–æ–∑–¥–∞–µ–º –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
            const panel = document.createElement('div');
            panel.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                z-index: 9999;
                background: rgba(0,0,0,0.8);
                color: white;
                padding: 10px;
                border-radius: 5px;
                font-family: Arial, sans-serif;
                display: flex;
                flex-direction: column;
                gap: 8px;
            `;

            panel.innerHTML = `
                <button id="suflerToggle" style="
                    background: #4CAF50;
                    color: white;
                    border: none;
                    padding: 8px 15px;
                    border-radius: 4px;
                    cursor: pointer;
                ">üé§ –í–∫–ª—é—á–∏—Ç—å —Å—É—Ñ–ª–µ—Ä</button>
                <button id="toggleEditorBtn" style="
                    background: #3498db;
                    color: white;
                    border: none;
                    padding: 8px 15px;
                    border-radius: 4px;
                    cursor: pointer;
                ">üìù –°–∫—Ä—ã—Ç—å —Ä–µ–¥–∞–∫—Ç–æ—Ä</button>
                <div id="suflerStatus" style="margin-top:5px;font-size:13px;">
                    –ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ
                </div>
            `;
            document.body.appendChild(panel);

            const suflerToggle = document.getElementById('suflerToggle');
            const toggleEditorBtn = document.getElementById('toggleEditorBtn');
            const statusEl = document.getElementById('suflerStatus');
            let recognition;
            let isActive = false;

            // –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞
            function centerElement(element) {
                if (!element) return;
                
                const elementRect = element.getBoundingClientRect();
                const viewportHeight = window.innerHeight;
                const targetScrollPos = elementRect.top + window.pageYOffset - (viewportHeight * config.targetPositionRatio);
                
                window.scrollTo({
                    top: targetScrollPos,
                    behavior: 'smooth'
                });
            }

            // –ü–æ–∏—Å–∫ –ª—É—á—à–µ–≥–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è
            function findBestMatch(words) {
                const elements = document.querySelectorAll('#preview p, #preview h1, #preview h2, #preview h3, #preview li');
                let bestMatch = { element: null, score: 0 };

                elements.forEach(el => {
                    const text = el.textContent.toLowerCase();
                    let score = 0;

                    words.forEach((word, index) => {
                        if (word.length >= config.minWordLength && text.includes(word)) {
                            score += config.wordWeights[index] || 0;
                        }
                    });

                    if (score > bestMatch.score) {
                        bestMatch = { element: el, score: score };
                    }
                });

                return bestMatch.element;
            }

            // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∏ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ
            function processWords(words) {
                document.querySelectorAll('.sufler-highlight, .sufler-active-block').forEach(el => {
                    el.classList.remove('sufler-highlight', 'sufler-active-block');
                });

                const targetElement = findBestMatch(words);
                
                if (targetElement) {
                    targetElement.classList.add('sufler-active-block');
                    
                    let newHTML = targetElement.innerHTML;
                    words.forEach(word => {
                        if (word.length >= config.minWordLength) {
                            newHTML = newHTML.replace(
                                new RegExp(`(${word})`, 'gi'),
                                '<span class="sufler-highlight">$1</span>'
                            );
                        }
                    });
                    targetElement.innerHTML = newHTML;

                    centerElement(targetElement);
                    statusEl.textContent = `–ù–∞–π–¥–µ–Ω–æ: "${words.slice(-1)[0]}"`;
                } else {
                    statusEl.textContent = '–ù–µ –Ω–∞–π–¥–µ–Ω–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π';
                }
            }

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
            function initRecognition() {
                if (!('webkitSpeechRecognition' in window)) {
                    statusEl.textContent = '–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è';
                    suflerToggle.disabled = true;
                    return null;
                }

                const rec = new webkitSpeechRecognition();
                rec.continuous = true;
                rec.interimResults = true;
                rec.lang = 'ru-RU';

                rec.onresult = function(event) {
                    const results = Array.from(event.results);
                    const last = results[results.length - 1];
                    
                    if (last.isFinal) {
                        const transcript = last[0].transcript.trim();
                        const confidence = last[0].confidence;
                        
                        if (confidence >= config.confidenceThreshold) {
                            const words = transcript.split(/\s+/)
                                .filter(w => w.length >= config.minWordLength)
                                .slice(-config.wordWeights.length);
                            
                            if (words.length > 0) {
                                processWords(words);
                            }
                        }
                    }
                };

                rec.onerror = function(event) {
                    statusEl.textContent = `–û—à–∏–±–∫–∞: ${event.error}`;
                    stopRecognition();
                };

                rec.onend = function() {
                    if (isActive) {
                        setTimeout(startRecognition, 300);
                    }
                };

                return rec;
            }

            function startRecognition() {
                if (!recognition) {
                    recognition = initRecognition();
                    if (!recognition) return;
                }

                try {
                    recognition.start();
                    isActive = true;
                    suflerToggle.textContent = 'üî¥ –í—ã–∫–ª—é—á–∏—Ç—å';
                    suflerToggle.style.background = '#f44336';
                    statusEl.textContent = '–°–ª—É—à–∞—é...';
                } catch (error) {
                    statusEl.textContent = '–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É';
                    console.error(error);
                }
            }

            function stopRecognition() {
                if (recognition) {
                    recognition.stop();
                }
                isActive = false;
                suflerToggle.textContent = 'üé§ –í–∫–ª—é—á–∏—Ç—å';
                suflerToggle.style.background = '#4CAF50';
                statusEl.textContent = '–ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤—ã–∫–ª—é—á–µ–Ω';
            }

            // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—É—Ñ–ª–µ—Ä–æ–º
            suflerToggle.addEventListener('click', function() {
                if (isActive) {
                    stopRecognition();
                } else {
                    startRecognition();
                    window.focus(); // –§–æ–∫—É—Å–∏—Ä—É–µ–º –æ–∫–Ω–æ –±—Ä–∞—É–∑–µ—Ä–∞
                }
            });

            // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–¥–∞–∫—Ç–æ—Ä–æ–º
            toggleEditorBtn.addEventListener('click', function() {
                editorContainer.classList.toggle('hidden-editor');
                preview.classList.toggle('full-width-preview');
                
                if (editorContainer.classList.contains('hidden-editor')) {
                    toggleEditorBtn.textContent = 'üìù –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–¥–∞–∫—Ç–æ—Ä';
                } else {
                    toggleEditorBtn.textContent = 'üìù –°–∫—Ä—ã—Ç—å —Ä–µ–¥–∞–∫—Ç–æ—Ä';
                }
            });

            // –î–µ–ª–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É "—Ñ–æ–∫—É—Å–∏—Ä—É–µ–º–æ–π" –¥–ª—è –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –≥–æ—Ä—è—á–∏—Ö –∫–ª–∞–≤–∏—à
            document.body.tabIndex = 0;
            document.body.style.outline = 'none'; // –£–±–∏—Ä–∞–µ–º –≤–∏–∑—É–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç —Ñ–æ–∫—É—Å–∞

            // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –≥–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏ (—Ä–∞–±–æ—Ç–∞—é—Ç –¥–∞–∂–µ –µ—Å–ª–∏ –æ–∫–Ω–æ –Ω–µ –≤ —Ñ–æ–∫—É—Å–µ)
            window.addEventListener('keydown', function(e) {
                // Pause/Break - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—É—Ñ–ª–µ—Ä–æ–º
                if (e.code === 'Pause') {
                    e.preventDefault();
                    if (isActive) {
                        stopRecognition();
                    } else {
                        startRecognition();
                        window.focus(); // –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º —Ñ–æ–∫—É—Å
                    }
                }
                // Ctrl+E - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–¥–∞–∫—Ç–æ—Ä–æ–º
                if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
                    e.preventDefault();
                    toggleEditorBtn.click();
                }
            });
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
        const observer = new MutationObserver(function(mutations) {
            initIntegratedSufler();
            observer.disconnect();
        });
        observer.observe(document.getElementById('preview'), { childList: true });
    })();
    </script>
</body>
</html>